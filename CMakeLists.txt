# Scratcher project
# Copyright (c) 2025 l2xl (l2xl/at/proton.me)
# Distributed under the Intellectual Property Reserve License (IPRL)
# -----BEGIN PGP PUBLIC KEY BLOCK-----
#
# mDMEYdxcVRYJKwYBBAHaRw8BAQdAfacBVThCP5QDPEgSbSIudtpJS4Y4Imm5dzaN
# lM1HTem0IkwyIFhsIChsMnhsKSA8bDJ4bEBwcm90b25tYWlsLmNvbT6IkAQTFggA
# OBYhBKRCfUyWnduCkisNl+WRcOaCK79JBQJh3FxVAhsDBQsJCAcCBhUKCQgLAgQW
# AgMBAh4BAheAAAoJEOWRcOaCK79JDl8A/0/AjYVbAURZJXP3tHRgZyYyN9txT6mW
# 0bYCcOf0rZ4NAQDoFX4dytPDvcjV7ovSQJ6dzvIoaRbKWGbHRCufrm5QBA==
# =KKu7
# -----END PGP PUBLIC KEY BLOCK-----

cmake_minimum_required(VERSION 3.21)

if(POLICY CMP0167)
    cmake_policy(SET CMP0167 OLD)
endif()

project(exscratcher VERSION 0.1 LANGUAGES CXX)

include(cmake/CPM.cmake)

set(CMAKE_VERBOSE_MAKEFILE on)

set(CMAKE_AUTOUIC ON)
set(CMAKE_AUTOMOC ON)
set(CMAKE_AUTORCC ON)

set(CMAKE_CXX_STANDARD 23)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

#CPMAddPackage(
#        NAME "Qt"
#        VERSION "6.9.0"
#        GIT_TAG "v6.9.0"
#        GITHUB_REPOSITORY "qt/qt5")
#CPMAddPackage("gh:qt/qt5@6.9.0")

find_package(Qt6 6 CONFIG REQUIRED COMPONENTS Core Widgets Svg)

find_package(OpenSSL REQUIRED)

set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -Wno-unqualified-std-cast-call -pthread")

find_package(Boost 1.83 REQUIRED COMPONENTS context system url)

# Add oneTBB library
CPMAddPackage(
    NAME TBB
    GITHUB_REPOSITORY oneapi-src/oneTBB
    GIT_TAG v2022.1.0
    OPTIONS
        "TBB_TEST OFF"
        "TBB_EXAMPLES OFF"
)

# Add SQLiteCpp with bundled SQLite sources
CPMAddPackage(
    NAME SQLiteCpp
    GITHUB_REPOSITORY SRombauts/SQLiteCpp
    GIT_TAG 3.3.3
    OPTIONS
        "SQLITECPP_INTERNAL_SQLITE ON"
        "SQLITE_ENABLE_COLUMN_METADATA ON"
        "SQLITE_ENABLE_JSON1 ON"
        "SQLITE_ENABLE_ASSERT_HANDLER ON"
        "SQLITECPP_BUILD_EXAMPLES OFF"
        "SQLITECPP_BUILD_TESTS OFF"
)

# Add Glaze for fast JSON serialization
CPMAddPackage(
    NAME glaze
    GITHUB_REPOSITORY stephenberry/glaze
    GIT_TAG v5.5.4
    OPTIONS
        "glaze_DEVELOPER_MODE OFF"
)

set(core_SOURCES
        src/common/currency.hpp
        src/common/timedef.hpp
        src/common/data_rectangle.hpp
        src/core/scheduler.cpp
        src/core/scheduler.hpp
        src/data/buoy_candle.cpp
        src/data/buoy_candle.hpp
        # DEPRECATED: src/data/bybit.cpp - replaced by datahub stack
        # DEPRECATED: src/data/bybit.hpp - replaced by datahub stack
        src/data/data_provider.cpp
        src/data/data_provider.hpp
        src/data/entities/common.hpp
        src/data/entities/common.cpp
        src/data/entities/instrument.hpp
        src/data/entities/trade.hpp
        # DEPRECATED: src/data/bybit/stream.cpp - replaced by websock_connection + data_sink
        # DEPRECATED: src/data/bybit/stream.hpp - replaced by websock_connection + data_sink
        src/data/bybit/data_manager.cpp
        src/data/bybit/data_manager.hpp
        src/data/bybit/error.hpp
        # DEPRECATED: src/data/bybit/subscription.hpp - absorbed into data_sink pattern
        src/connect/connection_context.hpp
        src/connect/connection_context.cpp
        src/connect/http_query.hpp
        src/connect/http_query.cpp
        src/connect/websocket.hpp
        src/connect/websocket.cpp
        src/datahub/data_model.hpp
        src/datahub/operations.hpp
        src/datahub/query_builder.hpp
        src/datahub/query_builder.cpp
        src/datahub/metadata.hpp
        src/datahub/data_sink.hpp
        src/datahub/data_provider.hpp
)

add_library(core STATIC ${core_SOURCES})

set(PROJECT_SOURCES
        src/main.cpp
        src/config.hpp
        src/config.cpp
        src/widget/scratch_widget.cpp
        src/widget/scratch_widget.h
        src/widget/content_frame.h
        src/widget/content_frame.cpp
        src/widget/instrument_dropbox.h
        src/widget/instrument_dropbox.cpp
        src/widget/scratcher.hpp
        src/widget/quote_scratcher.cpp
        src/widget/quote_scratcher.hpp
        src/app/trade_cockpit.cpp
        src/app/trade_cockpit.h
        src/app/trade_cockpit.ui
        src/app/view_controller.hpp
        src/app/market_controller.cpp
        src/app/market_controller.hpp
)

qt_add_executable(exscratcher MANUAL_FINALIZATION ${PROJECT_SOURCES})

include_directories(
        contrib
        src
        src/common
        src/core
        src/app
        src/data
        src/data/entities
        src/datahub
        src/widget
)

target_link_libraries(core PRIVATE ${Boost_LIBRARIES})
target_link_libraries(core PRIVATE OpenSSL::SSL)
target_link_libraries(core PRIVATE TBB::tbb)
target_link_libraries(core PUBLIC SQLiteCpp)
target_link_libraries(core PUBLIC glaze::glaze)

target_link_libraries(exscratcher PRIVATE core Qt6::Widgets Qt6::Svg)

include(GNUInstallDirs)
install(TARGETS exscratcher
    BUNDLE DESTINATION .
    LIBRARY DESTINATION ${CMAKE_INSTALL_LIBDIR}
    RUNTIME DESTINATION ${CMAKE_INSTALL_BINDIR}
)

qt_finalize_executable(exscratcher)

if(NOT ANDROID)

    CPMAddPackage("gh:catchorg/Catch2@3.5.4")
    #find_package(Catch2 3 REQUIRED)

    # Function to create test executable for each test file
    function(add_test TEST_NAME TEST_FILE)
        add_executable(${TEST_NAME} ${TEST_FILE})
        target_link_libraries(${TEST_NAME} PRIVATE core)
        target_link_libraries(${TEST_NAME} PRIVATE Catch2::Catch2WithMain)
        target_link_libraries(${TEST_NAME} PRIVATE ${Boost_LIBRARIES})
        target_link_libraries(${TEST_NAME} PRIVATE OpenSSL::SSL)
        target_link_libraries(${TEST_NAME} PRIVATE TBB::tbb)
        target_link_libraries(${TEST_NAME} PRIVATE glaze::glaze)
        target_link_libraries(${TEST_NAME} PRIVATE SQLiteCpp)
    endfunction()

    # Add each test file as a separate executable
    add_test(test_currency test/common/test_currency.cpp)
    add_test(test_buoy_candle test/core/test_buoy_candle.cpp)
    add_test(test_dao test/datahub/test_dao.cpp)
    add_test(test_http_query test/connect/test_http_query.cpp)
    add_test(test_websocket test/connect/test_websocket.cpp)
    add_test(test_data_sink test/datahub/test_data_sink.cpp)
    add_test(test_data_model test/bybit/test_data_model.cpp)

endif()

